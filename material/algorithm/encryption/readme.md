# 密码学

信息加解密分为对称加密（Sysmmetric Cryptography）和非对称加密（Public-Key Cryptography，Asymmetric Cryptography），这两者的区别是是否使用了相同的密钥。

除了信息的加解密，还有用于确认数据完整性（Integrity）的单向散列（One-Way Hash Function）技术，又称密码检验（Cryptographic Checksum）、指纹 （Fingerprint）、消息摘要 （Message Digest）。

信息的加解密与信息的单向散列的区别是，对称与非对称加密是可以通过密钥解出明文，而单向散列是不可逆的。信息的加解密，密文必定是不定长的，而单向散列可以是定长的。

结合密码学的加解密技术和单向散列技术，又有了用于防止篡改的消息认证码技术，防止伪装的数字签名技术以及认证证书。

## 密码检验

### MD5（MD5 Message-Digest Algorithm，MD5 消息摘要算法）

除了hash+salt，现在大多公司都采用无论密码长度多少，计算字符串hash时间都固定或者足够慢的算法如PBKDF2WithHmacSHA1，来降低硬件计算hash速度，减少不同长度字符串计算hash所需时间不一样而泄漏字符串长度信息，进一步减少风险。

MD 散列算法分为 MD4, MD5 两套算法，都可计算出 128 bits 的散列。MD 系列算法已经被中国科学家王小云破解（可于有限时间内找出碰撞）。

> MD算法被破解了,为什么现在大多数公司还采用这种方法存密码？
> 首页我们要清楚，MD被破解的是MD5碰撞问题，那么碰撞是什么意思呢？其实就是说破解的是如果已知原来的信息是aaaaaaaaaa，散列值是10，通过某方法，能迅速的找到一个信息aaaXaaaXaa，散列值也是10。那么这会造成什么影响呢？1）签名认证，证明某段信息没有被修改。2）密码验证，证明你确实知道某个密码；但是其实加了salt后，因为不同的用户salt不同。黑客针对每个用户进行暴力破解其实边际成本很大的。
> 用bcrypt，可以随意调节运算需要的时间，比MD5慢千万倍，每秒钟只能算出3个密码。这里要注意，就算是单纯使用bcrypt，而不给密码加盐，也是不安全的。另外这里会使系统的运行成本大大增加。但是做密码验证不频繁的系统，可以考虑。

### SHA（Secure Hash Algorithm，安全散列算法）

SHA 是单向散列算法的一个标准的统称，其下又分为 SHA-1, SHA-2, SHA-3 三套算法。

其中 SHA-1 可生成 160 bit 散列值，已被攻破（由王小云、姚期智联手破解），不推荐使用。

SHA-2 可生成不同长度的散列，如 256 bits (SHA-256), 384 bits (SHA-384), 512 bits (SHA-512)，同时对输入的消息长度存在一定限制，SHA-256 上限接近于 $2^{64}-1$ 比特，SHA-384、SHA512 则接近于 $2^{128}-1$ 比特。

SHA-3，是 2012 年被采用的最新标准，采用了 Keccak 算法。

Keccak 算法的优点：

1.采用与 SHA2 完全不同的结构
2.结构清晰，易于分析
3.适用于各种硬件，性能优越
4.可生成任意长度
5.对消息长度无限制
6.可采用双工结构，输入同时输出，提升效率

安全哈希算法（Secure Hash Algorithm）主要适用于数字签名标准（Digital Signature Standard DSS）里面定义的数字签名算法（Digital Signature Algorithm DSA）。

> SHA与MD5的异同？
> 因为二者均由MD4导出，SHA-1和MD5彼此很相似。相应的，他们的强度和其他特性也是相似，但还有以下几点不同：
> 对强行攻击的安全性：最显著和最重要的区别是SHA-1摘要比MD5摘要长32 位。使用强行技术，产生任何一个报文使其摘要等于给定报摘要的难度对MD5是2^128数量级的操作，而对SHA-1则是2^160数量级的操作。这样，SHA-1对强行攻击有更大的强度。
> 对密码分析的安全性：由于MD5的设计，易受密码分析的攻击，SHA-1显得不易受这样的攻击。
> 速度：在相同的硬件上，SHA-1的运行速度比MD5慢。

## 对称加密

### DES（Data Encryption Standard，数据加密标准）

DES 算法是以 64 bits 明文为一个单位（每隔 7 bits 会有一个 checksum bit，因此实际有效为 56 bits），分组对明文进行加密的，是一种分组密码（Block Cipher）算法。DES 算法原理是通过一个称为 Feistel 网络，并经过 N 轮的轮函数的计算实现的。是对称加密。

DES 于 1977 年公布，现已被破解。

*三重 DES（Triple-DES）*：又称为 TDEA（Triple Data Encryption Algorithm）或 3DES。3DES 是在 DES 基础算法上的改良，采用 3组 56 bits 共 168 bit 的密钥，对明文数据进行 3次 DES 加密-解密-加密操作，可见，若 3组密码均一样，则 3DES == DES。因此该算法可向下兼容 DES 加密算法。 3DES 考虑了兼容性，但计算性能不高，暂时还未被破解。

### AES（Advanced Encryption Standard，高级加密标准）

AES 是于 2000 年被采用的最新的对称加密标准，采用了 Rijndael 算法。也是对称加密的。

Rijndael 算法也是一种分组算法，密钥长度规定为 128 bits，192 bits， 256 bits 三种规格。

Rijindael 算法，可自由免费使用，安全、快速，暂未被破解。推荐使用。

## 非对称加密

非对称加密可以用于解决密钥配送问题。

### 非对称加密流程

1.接收方生成公私钥对，私钥由接收方保管

2.接收方将公钥发送给发送方

3.发送方通过公钥对明文加密，得到密文

4.发送方向接收方发送密文

5.接收方通过私钥解密密文，得到明文

无法解决公钥认证的问题，可能被中间人伪造公钥。

### RSA（Rivest-Shamir-Adleman）

RSA是最著名的非对称加密算法。是基于现阶段对大整数的质因数分解未发现高效的算法。一旦发现能快速对大整数进行质因数分解，则 RSA 就能够破译。

默认的 RSA 长度为 2048 bit

RSA的问题：

1. 效率慢，因此工业场景下，往往是通过非对称加密配送密钥，对称加密加密明文的混合加密方式，最著名的如 SSL。
2. 公钥认证问题难。消息发送方无法确认公钥的身份问题，应该收到甲的公钥，却收到了乙的。
3. 无法避免中间人攻击。可能被人于中间劫持后，发送一个伪造的公钥，此公钥加密后的密文，可以被劫持者解密，之后所有的密文都对劫持者透明了。
4. 选择密文攻击，即通过不断的发送请求，分析请求的反馈，猜测密钥和明文。有改良算法 RSA-OAEP （Optimal Asymmetric Encryption Padding）最优非对称加密填充，该算法是通过对明文前加入认证信息头，若信息头校验失败，则拒绝请求。

## 数字签名

### 数字签名步骤

1. 签名方 A 生成非对称公私钥对 public-key、private-key
2. A 向消息接收方 B 发送公钥 publi-key
3. A 采用 private-key 加密（一般是对消息的散列值进行加密），生成数字签名
4. A 将消息与数字签名发往 B
5. B 采用 public-key 解密数字签名
6. B 验证数字签名

由于用于解密的是公钥，是公开的。因此任何人都可以验证数字签名。

### 数字签名实现

数字签名的核心，就是非对称加密，在前文已经介绍了一些非对称加密算法，均可用于数字签名之中。

常见的有如下几种：

RSA
ElGamal
DSA

### 数字签名的问题

数字签名由于采用了非对称加密，因此可以防止否认。但发送方怎么能知道所收到的公钥就是接收方私钥所对应的公钥呢？

如果不小心采用了攻击者的公钥，然后接收了攻击者私钥签名的信息，公私钥完全匹配，于是信息就被接受了，那么就 GG 了。（中间人攻击）

因此，业界便推出了证书。由权威机构颁布，认证公钥的合法性，那么就 OK 啦~（PS:在实际应用中，还有一种常见的方案，用户自己生成公钥和私钥，然后把公钥复制或者上传到系统。这样就可以免登陆使用系统了。比如git的SSH keys。）

## 证书

对数字签名所发布的公钥进行权威的认证，便是证书。证书可以有效地避免中间人攻击的问题。

*PKC*：Public-Key Certificate，公钥证书，简称证书。
*CA*：Certification Authority，认证机构。对证书进行管理，负责 1.生成密钥对、2. 注册公钥时对身份进行认证、3. 颁发证书、4. 作废证书。其中负责注册公钥和身份认证的，称为 RA（Registration Authority 注册机构）

https的流程：服务器A使用数字签名，生成公钥和私钥。然后服务器A的所有者把公钥给上传到CA。CA在对公钥再施加数字签名并生成证书给服务器A。浏览器访问服务器A的时候，获取到CA颁发给服务器A的证书，然后去CA根据这个证书获取服务器A的公钥。再把数据通过这个公钥加密发送给服务器A。服务器在对这个公钥解密。

浏览器是如何确认证书是正确的，不是一个假的？

首先，浏览器内置了一些可信的根证书。（我们在做前端开发的时候，需要在电脑上调试手机网页，需要安装证书，其实就是一个新家内置根证书的过程？）。每个证书都是由上级颁发者的私钥加密的。所以浏览器会依次判断当前正式的上级颁发者是否正确，最终至根证书。

浏览器收到服务器返回的证书后, 会验证证书有效性. 验证步骤大概如下:

- 验证证书有效期(起止时间)
- 验证证书域名(与浏览器地址栏中域名是否匹配)
- 验证证书吊销状态(CRL+OCSP).
- 验证证书颁发机构, 如果颁发机构是中间证书, 在验证中间证书的有效期/颁发机构/吊销状态. 一直验证到最后一层证书, 如果最后一层证书是在操作系统或浏览器内置, 那么就是可信的, 否则就是自签名.

若检查通过,浏览器会获取到的服务器公钥，采用对称加密的方式，将新的session key发送给服务器。而服务器通过是要获取到session key了之后，双方就可以通过session key来采用对称加密的方式来进行数据交换了。

### HTTPS 是否会拖慢性能

浏览器在加密 session ticket3时, 和服务器在接受浏览器返回 session ticket3时, 是非对称加密中可能出现耗时的步骤. 但这个步骤顶多几毫秒, 并且现代化浏览器和 NGINX 已经支持 session 复用, 造成的性能损耗几乎可以忽略不计.

而真正可能拖慢性能的, 只可能是在吊销检查步骤中.

吊销状态检查只能是同步的, 那么受到 CA 厂商的部署限制, 极可能会将 CRL 服务器和 OCSP 服务器部署在遥远的小机房, 带宽/链路都是极差的, 这种, DNS 解析和连接 CRL/OCSP 服务器均需要耗时, 此过程的损耗, 是一大批在知乎的所谓专家所言的加密解密过程损耗的数十倍到数百倍.

### 怎么规避吊销状态带来的损耗

1. 百度阿里腾讯和苹果微软操作系统各种常见网站和软体的服务器/代码签名证书, 均有 CRL 和 OCSP, 而 CRL 是操作系统层复用的, 只要在 TTL 时间内, 操作系统检查过对应 CA 的 CRL, 那么 CRL 均可避免二次下载, 用户访问就可实现加速. OCSP 也至少可以搭上一个免去 DNS 解析的红利. 例如 Symantec/GeoTrust/GlobalSign
2. 买国内 CA 的证书. 我指的是真正自己在浏览器根证书的 CA 啊,不包括仅仅是中间证书分销商, 也不包括前面被除名然后变成分销商的WoSign.

## 混合密码系统

混合加密就是对称加密与非对称加密的结合。由于对称加密算法速度快，强度高，而非对称加密算法效率低，但能解决密钥配送问题。因此可以通过非对称加密配送对称密钥，再采用对称密钥用来加密的方式，实现网络的密钥配送与通信加密。

一般实践中，公钥通过证书认证配送，而对称加密用的密钥是每次随机产生。因此公钥密码的强度应该高于对称密码，因为对称密码只对当前一条信息负责，而非对称密码会影响到过完与未来所有的通信。

## 分组密码加密模式

分组密码(block cipher)，是每次只能处理特定长度的一块数据的一类密码算法，这里的“一块”就称为分组(block)。一个分组的比特数就称为分组长度(block length)。

流密码(stream cipher)，是对数据流进行连续处理的一类密码算法。

DES、3DES、AES等大多数对称密码算法都属于分组密码。

### ECB模式

全称Electronic CodeBook mode，电子密码本模式。

分组方式：将明文分组加密之后的结果直接称为密文分组。

优点：1） 一个分组损坏不影响其它分组。2）可以并行加解密。

缺点：1）相同的明文分组会转换为相同的密文分组。2）无需破译密码就能操纵明文（每个分组独立且前后文无关，直接增加或删除一个分组不影响其它分组解密过程的正确性）。

### CBC模式

全称Cipher Block Chaining mode，密码分组链接模式。

分组方式：将明文分组与前一个密文分组进行XOR运算(算法，找出不成对的数字的代码。任何数与自己进行位运算会变成0，0与任何数字异或还是原来的数字，位运算符合交换律。)，然后再进行加密。每个分组的加解密都依赖于前一个分组。而第一个分组没有前一个分组，因此需要一个初始化向量（initialization vector）。

优点： 1）加密结果与前文相关，有利于提高加密结果的随机性。2）可并行解密。

缺点： 1）无法并行加密。2）一个分组损坏，如果密文长度不变，则两个分组受影响。3）一个分组损坏，如果密文长度改变，则后面所有分组受影响。

### CFB模式

全称Cipher FeedBack mode，密文反馈模式。

分组方式：前一个密文分组会被送回到密码算法的输入端

### OFB模式

Output FeedBack mode 输出反馈模式

密码算法的输出会反馈到密码算法的输入中

## 整数质因子分解算法

## 参考文章

[密码学入了个门，总结一下](https://www.jianshu.com/p/a8070920810d)

[为安全计，请不要再使用md5](https://zhuanlan.zhihu.com/p/27335023)

[应用密码学的笑话之MD5+Salt不安全](https://blog.51cto.com/snow2016/1875489)

[HTTPs入门, 图解SSL从回车到握手](https://zhuanlan.zhihu.com/p/25587986)

[对称加密算法和分组密码的模式](https://www.jianshu.com/p/b63095c59361)
